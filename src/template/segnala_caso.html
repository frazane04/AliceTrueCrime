<section class="segnalazione-container">
    <header class="page-header">
        <h1>Apri un nuovo fascicolo</h1>
        <p>Hai informazioni su un caso non ancora trattato? Compila il rapporto preliminare con tutti i dettagli disponibili.</p>
    </header>

    <div id="feedback-area">
        <!-- I messaggi di feedback appariranno qui -->
    </div>

    <div class="form-wrapper">
        <form action="{{PATH_PREFIX}}/segnala-caso" method="POST" enctype="multipart/form-data" class="form-crimine" id="form-segnalazione">
            
            <!-- ========================================
                 SEZIONE 1: INFORMAZIONI GENERALI DEL CASO
                 ======================================== -->
            <fieldset class="form-section">
                <legend>üìã Informazioni Generali del Caso</legend>
                
                <div class="form-group">
                    <label for="titolo">Nome del Caso (Titolo) *</label>
                    <input type="text" 
                        id="titolo" 
                        name="titolo" 
                        placeholder="Es. Il mistero di..." 
                        required
                        minlength="5"
                        maxlength="200"
                        aria-describedby="titolo-hint"
                    />
                    <small id="titolo-hint" class="form-hint">Minimo 5 caratteri, massimo 200</small>
                </div>

                <div class="form-row">
                    <div class="form-group half">
                        <label for="data_crimine">Data Accaduto *</label>
                        <input type="date" 
                            id="data_crimine" 
                            name="data_crimine" 
                            required
                        />
                    </div>
                    <div class="form-group half">
                        <label for="luogo">Luogo *</label>
                        <input 
                            type="text" 
                            id="luogo" 
                            name="luogo" 
                            placeholder="Citt√†, Paese" 
                            required
                            maxlength="100"
                        />
                    </div>
                </div>

                <div class="form-group">
                    <label for="tipologia">Categoria del Caso</label>
                    <select id="tipologia" name="tipologia">
                        <option value="">-- Seleziona una categoria (opzionale) --</option>
                        <option value="Serial killer">Serial killer</option>
                        <option value="Amore tossico">Amore tossico</option>
                        <option value="Celebrity">Celebrity</option>
                        <option value="Casi mediatici italiani">Casi mediatici italiani</option>
                        <option value="Casi irrisolti">Casi irrisolti</option>
                        <option value="Altro">Altro</option>
                    </select>
                    <small class="form-hint">Seleziona la categoria pi√π appropriata per il caso</small>
                </div>

                <div class="form-group">
                    <label for="descrizione_breve">Descrizione Breve *</label>
                    <textarea 
                        id="descrizione_breve" 
                        name="descrizione_breve" 
                        rows="3" 
                        placeholder="Una sintesi del caso in poche righe (apparir√† nelle anteprime)"
                        required
                        maxlength="500"
                        aria-describedby="descrizione-breve-hint"
                    ></textarea>
                    <small id="descrizione-breve-hint" class="form-hint">Massimo 500 caratteri</small>
                </div>

                <div class="form-group">
                    <label for="storia">Ricostruzione Completa / Storia del Caso *</label>
                    <textarea 
                        id="storia" 
                        name="storia" 
                        rows="15" 
                        placeholder="Descrivi in dettaglio la sequenza degli eventi, le circostanze, le indagini, il processo e l'esito finale..."
                        required
                        minlength="50"
                        maxlength="10000"
                        aria-describedby="storia-hint"
                    ></textarea>
                    <small id="storia-hint" class="form-hint">Minimo 50 caratteri, massimo 10.000 caratteri</small>
                </div>

                <!-- IMMAGINE CASO -->
                <div class="form-group">
                    <label for="immagine_caso">Immagine del Caso (opzionale)</label>
                    <div class="file-upload-wrapper">
                        <input type="file" 
                            id="immagine_caso" 
                            name="immagine_caso" 
                            accept="image/jpeg,image/png,image/webp"
                            aria-describedby="immagine-caso-hint"
                            onchange="mostraAnteprimaImmagine(this, 'preview-caso')"
                        />
                        <small id="immagine-caso-hint" class="form-hint">Formati accettati: JPG, PNG, WebP. Max 5MB</small>
                    </div>
                    <div id="preview-caso" class="image-preview" aria-live="polite"></div>
                </div>
            </fieldset>

            <!-- ========================================
                 SEZIONE 2: VITTIME
                 ======================================== -->
            <fieldset class="form-section">
                <legend>üë§ Vittime del Caso</legend>
                <p class="section-intro">Aggiungi informazioni sulle vittime coinvolte. Puoi aggiungere pi√π vittime.</p>
                
                <div id="vittime-container">
                    <!-- Prima vittima (obbligatoria) -->
                    <div class="persona-entry vittima-entry" data-index="0">
                        <div class="entry-header">
                            <h4>Vittima #1</h4>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group half">
                                <label for="vittima_nome_0">Nome *</label>
                                <input type="text" 
                                    id="vittima_nome_0" 
                                    name="vittima_nome[]" 
                                    placeholder="Nome" 
                                    required
                                    maxlength="50"
                                />
                            </div>
                            <div class="form-group half">
                                <label for="vittima_cognome_0">Cognome *</label>
                                <input type="text" 
                                    id="vittima_cognome_0" 
                                    name="vittima_cognome[]" 
                                    placeholder="Cognome" 
                                    required
                                    maxlength="50"
                                />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group half">
                                <label for="vittima_luogo_nascita_0">Luogo di Nascita</label>
                                <input type="text" 
                                    id="vittima_luogo_nascita_0" 
                                    name="vittima_luogo_nascita[]" 
                                    placeholder="Citt√†, Paese" 
                                    maxlength="100"
                                />
                            </div>
                            <div class="form-group half">
                                <label for="vittima_data_nascita_0">Data di Nascita *</label>
                                <input type="date" 
                                    id="vittima_data_nascita_0" 
                                    name="vittima_data_nascita[]"
                                    required
                                />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group half">
                                <label for="vittima_data_decesso_0">Data di Decesso</label>
                                <input type="date" 
                                    id="vittima_data_decesso_0" 
                                    name="vittima_data_decesso[]"
                                />
                            </div>

                            <div class="form-group half">
                                <label for="vittima_immagine_0">Foto (opzionale)</label>
                                <input type="file" 
                                    id="vittima_immagine_0" 
                                    name="vittima_immagine[]" 
                                    accept="image/jpeg,image/png,image/webp"
                                    onchange="mostraAnteprimaImmagine(this, 'preview-vittima-0')"
                                />
                            </div>
                        </div>
                        <div id="preview-vittima-0" class="image-preview image-preview-small" aria-live="polite"></div>
                    </div>
                </div>

                <button type="button" class="btn-add-entry" id="btn-add-vittima">
                    ‚ûï Aggiungi un'altra vittima
                </button>
            </fieldset>

            <!-- ========================================
                 SEZIONE 3: COLPEVOLI
                 ======================================== -->
            <fieldset class="form-section">
                <legend>‚öñÔ∏è Colpevoli del Caso</legend>
                <p class="section-intro">Aggiungi informazioni sui colpevoli. Se irrisolto, inserisci "Ignoto".</p>
                
                <div id="colpevoli-container">
                    <!-- Primo colpevole (obbligatorio) -->
                    <div class="persona-entry colpevole-entry" data-index="0">
                        <div class="entry-header">
                            <h4>Colpevole #1</h4>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group half">
                                <label for="colpevole_nome_0">Nome *</label>
                                <input type="text" 
                                    id="colpevole_nome_0" 
                                    name="colpevole_nome[]" 
                                    placeholder="Nome (o 'Ignoto')" 
                                    required
                                    maxlength="50"
                                />
                            </div>
                            <div class="form-group half">
                                <label for="colpevole_cognome_0">Cognome *</label>
                                <input type="text" 
                                    id="colpevole_cognome_0" 
                                    name="colpevole_cognome[]" 
                                    placeholder="Cognome (o 'X')" 
                                    required
                                    maxlength="50"
                                />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group half">
                                <label for="colpevole_luogo_nascita_0">Luogo di Nascita</label>
                                <input type="text" 
                                    id="colpevole_luogo_nascita_0" 
                                    name="colpevole_luogo_nascita[]" 
                                    placeholder="Citt√†, Paese (o 'N/A')" 
                                    maxlength="100"
                                />
                            </div>
                            <div class="form-group half">
                                <label for="colpevole_data_nascita_0">Data di Nascita *</label>
                                <input type="date" 
                                    id="colpevole_data_nascita_0" 
                                    name="colpevole_data_nascita[]"
                                    required
                                />
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="colpevole_immagine_0">Foto (opzionale)</label>
                            <input type="file" 
                                id="colpevole_immagine_0" 
                                name="colpevole_immagine[]" 
                                accept="image/jpeg,image/png,image/webp"
                                onchange="mostraAnteprimaImmagine(this, 'preview-colpevole-0')"
                            />
                        </div>
                        <div id="preview-colpevole-0" class="image-preview image-preview-small" aria-live="polite"></div>
                    </div>
                </div>

                <button type="button" class="btn-add-entry" id="btn-add-colpevole">
                    ‚ûï Aggiungi un altro colpevole
                </button>
            </fieldset>

            <!-- ========================================
                 SEZIONE 4: FONTI E ARTICOLI
                 ======================================== -->
            <fieldset class="form-section">
                <legend>üì∞ Fonti e Articoli di Approfondimento</legend>
                <p class="section-intro">Aggiungi le fonti giornalistiche o documentali che supportano la ricostruzione.</p>
                
                <div id="articoli-container">
                    <div class="articolo-entry" data-index="0">
                        <div class="entry-header">
                            <h4>Fonte #1</h4>
                        </div>
                        
                        <div class="form-group">
                            <label for="articolo_titolo_0">Titolo Articolo/Fonte</label>
                            <input type="text" 
                                id="articolo_titolo_0" 
                                name="articolo_titolo[]" 
                                placeholder="Es. 'Approfondimento su...'" 
                                maxlength="200"
                            />
                        </div>

                        <div class="form-row">
                            <div class="form-group half">
                                <label for="articolo_data_0">Data Pubblicazione</label>
                                <input type="date" 
                                    id="articolo_data_0" 
                                    name="articolo_data[]"
                                />
                            </div>
                            <div class="form-group half">
                                <label for="articolo_link_0">Link Fonte</label>
                                <input type="url" 
                                    id="articolo_link_0" 
                                    name="articolo_link[]" 
                                    placeholder="https://esempio.it/articolo"
                                />
                            </div>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn-add-entry" id="btn-add-articolo">
                    ‚ûï Aggiungi un'altra fonte
                </button>
            </fieldset>

            <!-- ========================================
                 NOTA FINALE E INVIO
                 ======================================== -->
            <div class="form-notice">
                <p><strong>üìã Nota importante:</strong></p>
                <ul>
                    <li>La segnalazione verr√† inviata al team di moderazione per la revisione</li>
                    <li>Solo i casi verificati e con fonti attendibili verranno pubblicati</li>
                    <li>Le immagini devono essere in formato JPG, PNG o WebP (max 5MB)</li>
                    <li>Pi√π informazioni fornisci, pi√π veloce sar√† il processo di approvazione</li>
                </ul>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-submit">üì§ Invia Segnalazione Completa</button>
                <button type="reset" class="btn-reset" onclick="return confirm('Sei sicuro di voler cancellare tutti i dati inseriti?');">‚Ü∫ Cancella Tutto</button>
            </div>

        </form>
    </div>
</section>

<script>
// Contatori per entry dinamiche
let vittimeCount = 1;
let colpevoliCount = 1;
let articoliCount = 1;

// ========================================
// ANTEPRIMA IMMAGINI
// ========================================
function mostraAnteprimaImmagine(input, previewId) {
    const preview = document.getElementById(previewId);
    if (!preview) return;
    
    preview.innerHTML = '';
    
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Validazione client-side
        const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
        if (!validTypes.includes(file.type)) {
            preview.innerHTML = '<p class="error-text" role="alert">‚ö†Ô∏è Formato non supportato. Usa JPG, PNG o WebP.</p>';
            input.value = '';
            return;
        }
        
        if (file.size > 5 * 1024 * 1024) {
            preview.innerHTML = '<p class="error-text" role="alert">‚ö†Ô∏è File troppo grande. Max 5MB.</p>';
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.alt = 'Anteprima immagine caricata';
            img.className = 'preview-image';
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn-remove-preview';
            removeBtn.textContent = '‚úï Rimuovi';
            removeBtn.setAttribute('aria-label', 'Rimuovi immagine');
            removeBtn.onclick = function() {
                input.value = '';
                preview.innerHTML = '';
            };
            
            preview.appendChild(img);
            preview.appendChild(removeBtn);
        };
        reader.readAsDataURL(file);
    }
}

// ========================================
// GESTIONE VITTIME
// ========================================
document.getElementById('btn-add-vittima').addEventListener('click', function() {
    const container = document.getElementById('vittime-container');
    const index = vittimeCount;
    
    const html = `
    <div class="persona-entry vittima-entry" data-index="${index}">
        <div class="entry-header">
            <h4>Vittima #${index + 1}</h4>
            <button type="button" class="btn-remove-entry" onclick="removeEntry(this)" aria-label="Rimuovi vittima">üóëÔ∏è Rimuovi</button>
        </div>
        
        <div class="form-row">
            <div class="form-group half">
                <label for="vittima_nome_${index}">Nome *</label>
                <input type="text" id="vittima_nome_${index}" name="vittima_nome[]" placeholder="Nome" required maxlength="50"/>
            </div>
            <div class="form-group half">
                <label for="vittima_cognome_${index}">Cognome *</label>
                <input type="text" id="vittima_cognome_${index}" name="vittima_cognome[]" placeholder="Cognome" required maxlength="50"/>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group half">
                <label for="vittima_luogo_nascita_${index}">Luogo di Nascita</label>
                <input type="text" id="vittima_luogo_nascita_${index}" name="vittima_luogo_nascita[]" placeholder="Citt√†, Paese" maxlength="100"/>
            </div>
            <div class="form-group half">
                <label for="vittima_data_nascita_${index}">Data di Nascita *</label>
                <input type="date" id="vittima_data_nascita_${index}" name="vittima_data_nascita[]" required/>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group half">
                <label for="vittima_data_decesso_${index}">Data di Decesso</label>
                <input type="date" id="vittima_data_decesso_${index}" name="vittima_data_decesso[]"/>
            </div>
            <div class="form-group half">
                <label for="vittima_immagine_${index}">Foto (opzionale)</label>
                <input type="file" id="vittima_immagine_${index}" name="vittima_immagine[]" accept="image/jpeg,image/png,image/webp" onchange="mostraAnteprimaImmagine(this, 'preview-vittima-${index}')"/>
            </div>
        </div>
        <div id="preview-vittima-${index}" class="image-preview image-preview-small" aria-live="polite"></div>
    </div>
    `;
    
    container.insertAdjacentHTML('beforeend', html);
    vittimeCount++;
});

// ========================================
// GESTIONE COLPEVOLI
// ========================================
document.getElementById('btn-add-colpevole').addEventListener('click', function() {
    const container = document.getElementById('colpevoli-container');
    const index = colpevoliCount;
    
    const html = `
    <div class="persona-entry colpevole-entry" data-index="${index}">
        <div class="entry-header">
            <h4>Colpevole #${index + 1}</h4>
            <button type="button" class="btn-remove-entry" onclick="removeEntry(this)" aria-label="Rimuovi colpevole">üóëÔ∏è Rimuovi</button>
        </div>
        
        <div class="form-row">
            <div class="form-group half">
                <label for="colpevole_nome_${index}">Nome *</label>
                <input type="text" id="colpevole_nome_${index}" name="colpevole_nome[]" placeholder="Nome (o 'Ignoto')" required maxlength="50"/>
            </div>
            <div class="form-group half">
                <label for="colpevole_cognome_${index}">Cognome *</label>
                <input type="text" id="colpevole_cognome_${index}" name="colpevole_cognome[]" placeholder="Cognome (o 'X')" required maxlength="50"/>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group half">
                <label for="colpevole_luogo_nascita_${index}">Luogo di Nascita</label>
                <input type="text" id="colpevole_luogo_nascita_${index}" name="colpevole_luogo_nascita[]" placeholder="Citt√†, Paese" maxlength="100"/>
            </div>
            <div class="form-group half">
                <label for="colpevole_data_nascita_${index}">Data di Nascita *</label>
                <input type="date" id="colpevole_data_nascita_${index}" name="colpevole_data_nascita[]" required/>
            </div>
        </div>

        <div class="form-group">
            <label for="colpevole_immagine_${index}">Foto (opzionale)</label>
            <input type="file" id="colpevole_immagine_${index}" name="colpevole_immagine[]" accept="image/jpeg,image/png,image/webp" onchange="mostraAnteprimaImmagine(this, 'preview-colpevole-${index}')"/>
        </div>
        <div id="preview-colpevole-${index}" class="image-preview image-preview-small" aria-live="polite"></div>
    </div>
    `;
    
    container.insertAdjacentHTML('beforeend', html);
    colpevoliCount++;
});

// ========================================
// GESTIONE ARTICOLI
// ========================================
document.getElementById('btn-add-articolo').addEventListener('click', function() {
    const container = document.getElementById('articoli-container');
    const index = articoliCount;
    
    const html = `
    <div class="articolo-entry" data-index="${index}">
        <div class="entry-header">
            <h4>Fonte #${index + 1}</h4>
            <button type="button" class="btn-remove-entry" onclick="removeEntry(this)" aria-label="Rimuovi fonte">üóëÔ∏è Rimuovi</button>
        </div>
        
        <div class="form-group">
            <label for="articolo_titolo_${index}">Titolo Articolo/Fonte</label>
            <input type="text" id="articolo_titolo_${index}" name="articolo_titolo[]" placeholder="Es. 'Approfondimento su...'" maxlength="200"/>
        </div>

        <div class="form-row">
            <div class="form-group half">
                <label for="articolo_data_${index}">Data Pubblicazione</label>
                <input type="date" id="articolo_data_${index}" name="articolo_data[]"/>
            </div>
            <div class="form-group half">
                <label for="articolo_link_${index}">Link Fonte</label>
                <input type="url" id="articolo_link_${index}" name="articolo_link[]" placeholder="https://esempio.it/articolo"/>
            </div>
        </div>
    </div>
    `;
    
    container.insertAdjacentHTML('beforeend', html);
    articoliCount++;
});

// ========================================
// RIMUOVI ENTRY
// ========================================
function removeEntry(button) {
    const entry = button.closest('.persona-entry, .articolo-entry');
    if (entry && confirm('Sei sicuro di voler rimuovere questa entry?')) {
        entry.remove();
    }
}
</script>