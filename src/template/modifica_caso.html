<main class="container page-modifica-caso">
    <header class="page-header">
        <h1>‚úèÔ∏è Modifica Caso</h1>
        <p class="subtitle">Stai modificando: <strong><!-- caso_titolo --></strong></p>
    </header>

    <div id="feedback-area">
        <!-- feedback_message -->
    </div>

    <!-- avviso_riapprovazione -->

    <form method="POST" enctype="multipart/form-data" class="form-segnala" id="form-modifica-caso">
        <input type="hidden" name="action" value="modifica_caso">
        
        <!-- SEZIONE: Informazioni Caso -->
        <fieldset class="form-section">
            <legend>üìã Informazioni Generali</legend>
            
            <div class="form-group">
                <label for="titolo">Titolo del Caso *</label>
                <input type="text" id="titolo" name="titolo" required 
                       minlength="5" maxlength="200"
                       value="<!-- value_titolo -->"
                       placeholder="Es: Il caso di Via Poma">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="data_crimine">Data dell'Accaduto *</label>
                    <input type="date" id="data_crimine" name="data_crimine" required
                           value="<!-- value_data -->">
                </div>
                
                <div class="form-group">
                    <label for="luogo">Luogo *</label>
                    <input type="text" id="luogo" name="luogo" required
                           value="<!-- value_luogo -->"
                           placeholder="Es: Roma, Italia">
                </div>
            </div>

            <div class="form-group">
                <label for="tipologia">Categoria</label>
                <select id="tipologia" name="tipologia">
                    <!-- opzioni_tipologia -->
                </select>
            </div>

            <div class="form-group">
                <label for="descrizione_breve">Descrizione Breve * <small>(max 500 caratteri)</small></label>
                <textarea id="descrizione_breve" name="descrizione_breve" required
                          maxlength="500" rows="3"
                          placeholder="Breve sintesi del caso..."><!-- value_descrizione --></textarea>
            </div>

            <div class="form-group">
                <label for="storia">Ricostruzione Completa *</label>
                <textarea id="storia" name="storia" required
                          minlength="50" rows="10"
                          placeholder="Descrivi in dettaglio la storia del caso..."><!-- value_storia --></textarea>
            </div>

            <!-- IMMAGINE CASO -->
            <div class="form-group">
                <label for="immagine_caso">Immagine del Caso (opzionale)</label>
                <!-- anteprima_immagine_caso -->
                <div class="file-upload-wrapper">
                    <input type="file" 
                        id="immagine_caso" 
                        name="immagine_caso" 
                        accept="image/jpeg,image/png,image/webp"
                        aria-describedby="immagine-caso-hint"
                        onchange="mostraAnteprimaImmagine(this, 'preview-caso-new')"
                    />
                    <small id="immagine-caso-hint" class="form-hint">Formati: JPG, PNG, WebP. Max 5MB.</small>
                </div>
                <div id="preview-caso-new" class="image-preview" aria-live="polite"></div>
            </div>
        </fieldset>

        <!-- SEZIONE: Vittime -->
        <fieldset class="form-section">
            <legend>üïØÔ∏è Vittime</legend>
            <p class="section-hint">Modifica le vittime esistenti o aggiungine di nuove.</p>
            
            <div id="vittime-container">
                <!-- vittime_html -->
            </div>
            
            <button type="button" class="btn btn-secondary btn-add" onclick="aggiungiVittima()">
                + Aggiungi Vittima
            </button>
        </fieldset>

        <!-- SEZIONE: Colpevoli -->
        <fieldset class="form-section">
            <legend>‚öñÔ∏è Colpevoli / Sospettati</legend>
            <p class="section-hint">Modifica i colpevoli esistenti o aggiungine di nuovi.</p>
            
            <div id="colpevoli-container">
                <!-- colpevoli_html -->
            </div>
            
            <button type="button" class="btn btn-secondary btn-add" onclick="aggiungiColpevole()">
                + Aggiungi Colpevole
            </button>
        </fieldset>

        <!-- SEZIONE: Fonti/Articoli -->
        <fieldset class="form-section">
            <legend>üì∞ Fonti e Articoli</legend>
            <p class="section-hint">Aggiungi link a fonti attendibili.</p>
            
            <div id="articoli-container">
                <!-- articoli_html -->
            </div>
            
            <button type="button" class="btn btn-secondary btn-add" onclick="aggiungiArticolo()">
                + Aggiungi Fonte
            </button>
        </fieldset>

        <!-- PULSANTI AZIONE -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-lg">üíæ Salva Modifiche</button>
            <a href="<!-- link_annulla -->" class="btn btn-secondary">Annulla</a>
        </div>
    </form>

    <!-- SEZIONE ELIMINAZIONE -->
    <div class="danger-zone">
        <h3>Elimina Caso</h3>
        <p>L'eliminazione √® permanente. Verranno eliminate anche tutte le immagini associate.</p>
        
        <form method="POST" onsubmit="return confirm('‚ö†Ô∏è ATTENZIONE: Stai per eliminare definitivamente questo caso. Continuare?');">
            <input type="hidden" name="action" value="elimina_caso">
            <button type="submit" class="btn btn-danger">üóëÔ∏è Elimina Caso Definitivamente</button>
        </form>
    </div>
</main>

<script>
let vittimeCount = document.querySelectorAll('.vittima-entry').length;
let colpevoliCount = document.querySelectorAll('.colpevole-entry').length;
let articoliCount = document.querySelectorAll('.articolo-entry').length;

function mostraAnteprimaImmagine(input, previewId) {
    const preview = document.getElementById(previewId);
    if (!preview) return;
    preview.innerHTML = '';
    
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
        
        if (!validTypes.includes(file.type)) {
            preview.innerHTML = '<p class="error-text" role="alert">‚ö†Ô∏è Formato non supportato.</p>';
            input.value = '';
            return;
        }
        if (file.size > 5 * 1024 * 1024) {
            preview.innerHTML = '<p class="error-text" role="alert">‚ö†Ô∏è File troppo grande (max 5MB).</p>';
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `
                <img src="${e.target.result}" alt="Anteprima nuova immagine" class="preview-image">
                <button type="button" class="btn-remove-preview" onclick="rimuoviAnteprima('${input.id}', '${previewId}')">‚úï Rimuovi</button>
            `;
        };
        reader.readAsDataURL(file);
    }
}

function rimuoviAnteprima(inputId, previewId) {
    document.getElementById(inputId).value = '';
    document.getElementById(previewId).innerHTML = '';
}

function aggiungiVittima() {
    const container = document.getElementById('vittime-container');
    const idx = vittimeCount++;
    container.insertAdjacentHTML('beforeend', `
        <div class="entry-card vittima-entry">
            <button type="button" class="btn-remove" onclick="rimuoviEntry(this)" aria-label="Rimuovi vittima">√ó</button>
            <input type="hidden" name="vittima_id[]" value="0">
            <input type="hidden" name="vittima_immagine_esistente[]" value="">
            <div class="form-row">
                <div class="form-group"><label>Nome *</label><input type="text" name="vittima_nome[]" required placeholder="Nome"></div>
                <div class="form-group"><label>Cognome *</label><input type="text" name="vittima_cognome[]" required placeholder="Cognome"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Luogo Nascita</label><input type="text" name="vittima_luogo_nascita[]" placeholder="Luogo"></div>
                <div class="form-group"><label>Data Nascita</label><input type="date" name="vittima_data_nascita[]"></div>
                <div class="form-group"><label>Data Decesso</label><input type="date" name="vittima_data_decesso[]"></div>
            </div>
            <div class="form-group">
                <label>Foto (opzionale)</label>
                <input type="file" id="vittima_img_${idx}" name="vittima_immagine[]" accept="image/jpeg,image/png,image/webp" onchange="mostraAnteprimaImmagine(this, 'pv_${idx}')">
                <div id="pv_${idx}" class="image-preview image-preview-small"></div>
            </div>
        </div>
    `);
}

function aggiungiColpevole() {
    const container = document.getElementById('colpevoli-container');
    const idx = colpevoliCount++;
    container.insertAdjacentHTML('beforeend', `
        <div class="entry-card colpevole-entry">
            <button type="button" class="btn-remove" onclick="rimuoviEntry(this)" aria-label="Rimuovi colpevole">√ó</button>
            <input type="hidden" name="colpevole_id[]" value="0">
            <input type="hidden" name="colpevole_immagine_esistente[]" value="">
            <div class="form-row">
                <div class="form-group"><label>Nome *</label><input type="text" name="colpevole_nome[]" required placeholder="Nome"></div>
                <div class="form-group"><label>Cognome *</label><input type="text" name="colpevole_cognome[]" required placeholder="Cognome"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Luogo Nascita</label><input type="text" name="colpevole_luogo_nascita[]" placeholder="Luogo"></div>
                <div class="form-group"><label>Data Nascita</label><input type="date" name="colpevole_data_nascita[]"></div>
            </div>
            <div class="form-group">
                <label>Foto (opzionale)</label>
                <input type="file" id="colp_img_${idx}" name="colpevole_immagine[]" accept="image/jpeg,image/png,image/webp" onchange="mostraAnteprimaImmagine(this, 'pc_${idx}')">
                <div id="pc_${idx}" class="image-preview image-preview-small"></div>
            </div>
        </div>
    `);
}

function aggiungiArticolo() {
    const container = document.getElementById('articoli-container');
    container.insertAdjacentHTML('beforeend', `
        <div class="entry-card articolo-entry">
            <button type="button" class="btn-remove" onclick="rimuoviEntry(this)" aria-label="Rimuovi articolo">√ó</button>
            <input type="hidden" name="articolo_id[]" value="0">
            <div class="form-row">
                <div class="form-group"><label>Titolo Fonte</label><input type="text" name="articolo_titolo[]" placeholder="Titolo"></div>
                <div class="form-group"><label>Data</label><input type="date" name="articolo_data[]"></div>
            </div>
            <div class="form-group"><label>Link</label><input type="url" name="articolo_link[]" placeholder="https://..."></div>
        </div>
    `);
    articoliCount++;
}

function rimuoviEntry(button) {
    const entry = button.closest('.entry-card');
    const container = entry.parentElement;
    
    // Verifica che rimanga almeno un elemento per vittime e colpevoli
    
    if (container.id === 'vittime-container' && container.querySelectorAll('.vittima-entry').length <= 1) {
        alert('Deve esserci almeno una vittima.');
        return;
    }
    if (container.id === 'colpevoli-container' && container.querySelectorAll('.colpevole-entry').length <= 1) {
        alert('Deve esserci almeno un colpevole.');
        return;
    }
    
    entry.remove();
}
</script>